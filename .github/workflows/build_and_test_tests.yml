name: Build and Run Selected Tests

on:
  workflow_dispatch:
    inputs:
      test-selection:
        description: 'Specification of selected test(s), e. g.: test_runner/regress/test_pg_regress.py::test_pg_regress'
        required: true
        type: string
      run-count:
        description: 'Number of test runs to perform'
        required: true
        type: number
      archs:
        description: 'Archs to run tests on, e. g.: ["x64", "arm64"]'
        default: '["x64"]'
        required: true
        type: string
      build-types:
        description: 'Build types to run tests on, e. g.: ["debug", "release"]'
        default: '["release"]'
        required: true
        type: string
      pg-versions:
        description: 'Postgres versions to use for testing,  e.g,: [{"pg_version":"v16"}, {"pg_version":"v17"}])'
        default: '[{"pg_version":"v17"}]'
        required: true
        type: string
  workflow_call:
  pull_request: # TODO: remove before merge

defaults:
  run:
    shell: bash -euxo pipefail {0}

env:
  RUST_BACKTRACE: 1
  COPT: '-Werror'

jobs:
  meta:
    uses: ./.github/workflows/_meta.yml
    with:
      github-event-name: ${{ github.event_name }}
      github-event-json: ${{ toJSON(github.event) }}


  choose-test-parameters:
    runs-on: [ self-hosted, small ]
    container:
      image: ghcr.io/neondatabase/build-tools:pinned-bookworm
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --init

    outputs:
      tests: ${{ inputs.test-selection != '' && inputs.test-selection || steps.detect_tests_to_test.outputs.tests }}
      archs: ${{ inputs.test-selection != '' && inputs.archs  || '["x64", "arm64"]' }}
      build-types: ${{ inputs.test-selection != '' && inputs.build-types || '["release"]' }}
      pg-versions: ${{ inputs.test-selection != '' && inputs.pg-versions || '[{"pg_version":"v14"}, {"pg_version":"v17"}]' }}
      run-count: ${{ inputs.test-selection != '' && inputs.run-count || 5 }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        if: inputs.test-selection == ''
        with:
          submodules: false
          clean: false
          fetch-depth: 1000

      - name: Cache poetry deps
        if: inputs.test-selection == ''
        uses: actions/cache@v4
        with:
            path: ~/.cache/pypoetry/virtualenvs
            key: v2-${{ runner.os }}-${{ runner.arch }}-python-deps-bookworm-${{ hashFiles('poetry.lock') }}

      - name: Install Python deps
        if: inputs.test-selection == ''
        shell: bash -euxo pipefail {0}
        run: ./scripts/pysync

      - name: Detect new and updated tests
        id: detect_tests_to_test
        if: github.event.pull_request.head.sha && inputs.test-selection == ''
        env:
          COMMIT_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.sha }}
        run: python3 .github/scripts/detect-updated-pytests.py

  build-and-test-tests:
    needs: [ meta, choose-test-parameters ]
    if: needs.choose-test-parameters.outputs.tests != ''
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJson(needs.choose-test-parameters.outputs.archs) }}
        build-type: ${{ fromJson(needs.choose-test-parameters.outputs.build-types) }}
    uses: ./.github/workflows/_build-and-test-locally.yml
    with:
      arch: ${{ matrix.arch }}
      build-tools-image: ghcr.io/neondatabase/build-tools:pinned-bookworm
      build-tag: ${{ needs.meta.outputs.build-tag }}
      build-type: ${{ matrix.build-type }}
      test-cfg: ${{ needs.choose-test-parameters.outputs.pg-versions }}
      test-selection: ${{ needs.choose-test-parameters.outputs.tests }}
      test-run-count: ${{ fromJson(needs.choose-test-parameters.outputs.run-count) }}
    secrets: inherit

  create-test-report:
    needs: [ build-and-test-tests ]
    if: ${{ !cancelled() }}
    permissions:
      id-token: write # aws-actions/configure-aws-credentials
      statuses: write
      contents: write
      pull-requests: write
    outputs:
      report-url: ${{ steps.create-allure-report.outputs.report-url }}

    runs-on: [ self-hosted, small ]
    container:
      image: ghcr.io/neondatabase/build-tools:pinned-bookworm
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      options: --init

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@4d991eb9b905ef189e4c376166672c3f2f230481 # v2.11.0
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Create Allure report
        if: ${{ !cancelled() }}
        id: create-allure-report
        uses: ./.github/actions/allure-report-generate
        with:
          store-test-results-into-db: true
          aws-oidc-role-arn: ${{ vars.DEV_AWS_OIDC_ROLE_ARN }}
        env:
          REGRESS_TEST_RESULT_CONNSTR_NEW: ${{ secrets.REGRESS_TEST_RESULT_CONNSTR_DEV }}
          REPORT_EXT: '-ext'

      - uses: actions/github-script@v7
        if: ${{ !cancelled() }}
        with:
          # Retry script for 5XX server errors: https://github.com/actions/github-script#retries
          retries: 5
          script: |
            const report = {
              reportUrl:     "${{ steps.create-allure-report.outputs.report-url }}",
              reportJsonUrl: "${{ steps.create-allure-report.outputs.report-json-url }}",
            }

            const coverage = {}

            const script = require("./scripts/comment-test-report.js")
            await script({
              github,
              context,
              fetch,
              report,
              coverage,
            })
